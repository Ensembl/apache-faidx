language: c

sudo: required
dist: trusty

cache:
  directories:
    - $HOME/build/lairdm/apache-faidx/htslib

env:
  - COVERALLS=true
  - COVERALLS=false

addons:
  apt:
    packages:
      - apache2-prefork-dev
      - apache2-mpm-prefork
      - curl
      - ruby-dev
      - lcov

before_install:
  - if [ -d "htslib" ]; then (cd htslib && git pull); else git clone --branch develop --depth 1 https://github.com/lairdm/htslib.git; fi
  - cd htslib
  - pwd
  - make
  - sudo make install
  - export HTSLIB_DIR=$(pwd -P)
  - cd ..
  - sudo ldconfig
  - which gem
  - gem install coveralls-lcov

install:  
  - export APACHE_FAIDX_DIR=$(pwd -P)
  - sed -i -e 's@APACHE_FAIDX_DIR@'$APACHE_FAIDX_DIR'@g' t/faidx.conf
  - sed -i -e 's@APACHE_FAIDX_DIR@'$APACHE_FAIDX_DIR'@g' t/faidx_coveralls.load
  - if [[ "$COVERALLS" == "true" ]]; then sudo ln -s $(pwd -P)/t/faidx_coveralls.load /etc/apache2/mods-enabled/faidx.load; else sudo ln -s $(pwd -P)/t/faidx.load /etc/apache2/mods-enabled/; fi
  - sudo ln -s $(pwd -P)/t/faidx.conf /etc/apache2/mods-enabled/
  - ls -l /etc/apache2/mods-enabled/
  - if [[ "$COVERALLS" == "true" ]]; then lcov --directory . --zerocounters; fi
  - if [[ "$COVERALLS" == "true" ]]; then make coveralls; else make debug; fi
  - if [[ "$COVERALLS" == "true" ]]; then touch ${APACHE_FAIDX_DIR}/.libs/mod_faidx.gcda && chmod 666 ${APACHE_FAIDX_DIR}/.libs/mod_faidx.gcda && sudo chown root.root ${APACHE_FAIDX_DIR}/.libs/mod_faidx.gcda; fi
  - if [[ "$COVERALLS" == "false" ]]; then sudo make install; fi
  - ls -la ${APACHE_FAIDX_DIR}/.libs/
  - if [[ "$COVERALLS" == "true" ]]; then sudo apache2ctl stop; else sudo apache2ctl restart; fi
  - if [[ "$COVERALLS" == "true" ]]; then (sudo sh -c '. /etc/apache2/envvars; /usr/sbin/apache2 -X')& fi
  - if [[ "$COVERALLS" == "true" ]]; then sleep 2; fi
  - if [[ "$COVERALLS" == "true" ]]; then (ps auxww|grep apache2|grep -v grep); fi
  - if [[ "$COVERALLS" == "true" ]]; then (ps auxww|grep apache2|grep -v grep|awk '{print $2}'|xargs -I % sudo kill -s HUP %); fi
  - if [[ "$COVERALLS" == "true" ]]; then (ps auxww|grep apache2|grep -v grep); fi
  - if [[ "$COVERALLS" == "true" ]]; then (sudo sh -c '. /etc/apache2/envvars; /usr/sbin/apache2 -X')& fi
  - ls -la ${APACHE_FAIDX_DIR}/.libs/

script:
  - curl "http://localhost/faidx?set=human&location=1%3A1000-2000"
  - curl "http://localhost/faidx?set=human&location=Y%3A1000-2000"
  - curl "http://localhost/faidx/sets"
  - curl "http://localhost/faidx/locations/cat/"
  - curl "http://localhost/faidx/locations/human/"

after_success:
  - if [[ "$COVERALLS" == "true" ]]; then (ps auxww|grep apache2|grep -v grep|awk '{print $2}'|xargs -I % sudo kill -s HUP %); fi
  - if [[ "$COVERALLS" == "true" ]]; then (ps auxww|grep apache2); fi
  - if [[ "$COVERALLS" == "true" ]]; then (ps auxww|grep apache2|awk '{print $2}'|xargs -I % echo %); fi
  - if [[ "$COVERALLS" == "true" ]]; then sudo sync; fi
  - if [[ "$COVERALLS" == "true" ]]; then sleep 5; fi
  - if [[ "$COVERALLS" == "true" ]]; then lcov --directory . --capture --output-file coverage.info; fi
  - if [[ "$COVERALLS" == "true" ]]; then lcov --remove coverage.info 'test/*' '/usr/*' --output-file coverage.info; fi
  - if [[ "$COVERALLS" == "true" ]]; then lcov --list coverage.info; fi
  - if [[ "$COVERALLS" == "true" ]]; then coveralls-lcov --repo-token riAPmHw8OAaaaitWA26yBEIpGYLGyXQ6w coverage.info; fi
  - ls -la ${APACHE_FAIDX_DIR}/.libs/
  - ps auxww
  - sudo cat /var/log/apache2/error.log

after_failure:
  - sudo cat /var/log/apache2/error.log

notifications:
  email:
    on_success: change
    on_failure: change
